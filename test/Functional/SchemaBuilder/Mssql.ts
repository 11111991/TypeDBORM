import { SchemaContext } from "./Entities/SchemaContext";
import * as chai from "chai";
import { MockConnection } from "../../../src/Mock/MockConnection";
import { Schema } from "./Entities/Schema";
import { QueryType } from "../../../src/Common/Type";
import { SubSchema } from "./Entities/SubSchema";
import { entityMetaKey } from "../../../src/Decorator/DecoratorKey";
import { IEntityMetaData } from "../../../src/MetaData/Interface/IEntityMetaData";
import { BinaryColumnMetaData } from "../../../src/MetaData/BinaryColumnMetaData";
import { PooledConnection } from "../../../src/Connection/PooledConnection";
import { IConnection } from "../../../src/Connection/IConnection";
import { IntegerColumnMetaData } from "../../../src/MetaData/IntegerColumnMetaData";
import { ColumnIndex } from "../../../src/Decorator/ColumnIndex";
import { CheckConstraintMetaData } from "../../../src/MetaData/CheckConstraintMetaData";
import { UniqueConstraintMetaData } from "../../../src/MetaData/UniqueConstraintMetaData";
import { mockContext } from "../../../src/Mock/MockContext";

const db = new SchemaContext();
mockContext(db);
beforeEach(async () => {
    db.connection = await db.getConnection();
    db.connectionManager.getAllConnections = () => Promise.resolve([db.connection]);
});
afterEach(() => {
    db.clear();
    db.closeConnection();
});

const getConnection = (con: IConnection) => (con instanceof PooledConnection ? con.connection : con) as MockConnection;

describe("SCHEMA BUILDER - MSSQL", () => {
    describe("ENTITY", () => {
        it("should create new table correctly", async () => {
            const mockConnection = getConnection(db.connection);
            mockConnection.results = [{ "rows": [{ "SCHEMA": "dbo" }], "effectedRows": 1 }, { "rows": [], "effectedRows": 0 }, { "rows": [], "effectedRows": 0 }, { "effectedRows": 0 }, { "rows": [], "effectedRows": 0 }, { "rows": [], "effectedRows": 0 }, { "effectedRows": 0 }, { "rows": [], "effectedRows": 0 }, { "rows": [], "effectedRows": 0 }];

            const schemaQuery = await db.getUpdateSchemaQueries([Schema, SubSchema]);

            chai.should();
            schemaQuery.should.deep.include({
                "commit": [
                    {
                        query: "CREATE TABLE [dbo].[Schema]\n(\n\t[primaryKey] int NOT NULL IDENTITY(1,1),\n\t[boolean] bit NOT NULL,\n\t[decimal] decimal(10, 2) NOT NULL,\n\t[enum] nvarchar(255) NOT NULL,\n\t[identifier] uniqueidentifier NOT NULL,\n\t[integer] int NOT NULL,\n\t[nullable] bit,\n\t[real] real NOT NULL,\n\t[rowVersion] rowversion NOT NULL,\n\t[string] nvarchar(150) DEFAULT 'empty' NOT NULL,\n\t[date] date NOT NULL,\n\t[time] time(7) NOT NULL,\n\t[timeUTC] time(5) NOT NULL,\n\t[dateTime] datetime NOT NULL,\n\t[dateTimeUTC] datetime NOT NULL,\n\t[createdDate] datetime DEFAULT getutcdate() NOT NULL,\n\t[modifiedDate] datetime DEFAULT getutcdate() NOT NULL,\n\t[deleted] bit DEFAULT 0 NOT NULL,\n\tCONSTRAINT [PK_Schema] PRIMARY KEY ([primaryKey]),\n\tCONSTRAINT [CK_Schema_decimal] CHECK (([decimal]>=0)),\n\tCONSTRAINT [UQ_Schema_identifier] UNIQUE ([identifier]),\n\tCONSTRAINT [Schema_entity_unique] UNIQUE ([decimal],[real]),\n\tCONSTRAINT [Schema_entity_check] CHECK (([decimal]>[integer]))\n)",
                        type: 4
                    },
                    { query: "CREATE INDEX IX_deleted ON [Schema] ([deleted])", type: 4 },
                    { query: "CREATE TABLE [dbo].[SubSchema]\n(\n\t[identifier] uniqueidentifier NOT NULL,\n\t[name] nvarchar(255) NOT NULL,\n\tCONSTRAINT [PK_SubSchema] PRIMARY KEY ([identifier])\n)", type: 4 },
                    { query: "ALTER TABLE [dbo].[SubSchema] ADD CONSTRAINT [own_Schema_SubSchema] FOREIGN KEY ([identifier]) REFERENCES [dbo].[Schema] ([identifier])", type: 4 }
                ],
                "rollback": [
                    { query: "ALTER TABLE [dbo].[SubSchema] DROP CONSTRAINT [own_Schema_SubSchema]", type: 4 },
                    { query: "DROP TABLE [dbo].[Schema]", type: 4, "comment": "You might lost your data" },
                    { query: "DROP TABLE [dbo].[SubSchema]", type: 4, "comment": "You might lost your data" }
                ]
            });
        });
        it("should not detect any changes", async () => {
            const mockConnection = getConnection(db.connection);
            mockConnection.results = [{ "rows": [{ "SCHEMA": "dbo" }], "effectedRows": 1 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "TABLE_TYPE": "BASE TABLE" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "TABLE_TYPE": "BASE TABLE" }], "effectedRows": 2 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": true }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "boolean", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "ORDINAL_POSITION": 3, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "decimal", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 2, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "enum", "ORDINAL_POSITION": 4, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 5, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "ORDINAL_POSITION": 6, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "nullable", "ORDINAL_POSITION": 7, "COLUMN_DEFAULT": null, "IS_NULLABLE": "YES", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "ORDINAL_POSITION": 8, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "real", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 24, "NUMERIC_PRECISION_RADIX": 2, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "rowVersion", "ORDINAL_POSITION": 9, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "timestamp", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "string", "ORDINAL_POSITION": 10, "COLUMN_DEFAULT": "('empty')", "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 150, "CHARACTER_OCTET_LENGTH": 300, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "date", "ORDINAL_POSITION": 11, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "date", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "time", "ORDINAL_POSITION": 12, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 7, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "timeUTC", "ORDINAL_POSITION": 13, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 5, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTime", "ORDINAL_POSITION": 14, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTimeUTC", "ORDINAL_POSITION": 15, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "createdDate", "ORDINAL_POSITION": 16, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "modifiedDate", "ORDINAL_POSITION": 17, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "deleted", "ORDINAL_POSITION": 18, "COLUMN_DEFAULT": "((0))", "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "name", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }], "effectedRows": 20 }, { "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>=(0))" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>[integer])" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "FOREIGN KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }], "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "UNIQUE_CONSTRAINT_CATALOG": "Database", "UNIQUE_CONSTRAINT_SCHEMA": "dbo", "UNIQUE_CONSTRAINT_NAME": "UQ_Schema_identifier", "MATCH_OPTION": "SIMPLE", "UPDATE_RULE": "NO ACTION", "DELETE_RULE": "NO ACTION" }], "effectedRows": 1 }, { "effectedRows": 0 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }], "effectedRows": 9 }, { "rows": [{ "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pid" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pclass" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "thumbprint" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "deleted" }], "effectedRows": 4 }];

            const schemaQuery = await db.getUpdateSchemaQueries([Schema, SubSchema]);

            chai.should();
            schemaQuery.should.deep.equal({
                commit: [],
                rollback: []
            });
        });
    });
    describe("COLUMN", () => {
        it("should add new column", async () => {
            // add simple and identity column
            const entityMetaData = Reflect.getOwnMetadata(entityMetaKey, Schema) as IEntityMetaData;
            const binaryCol = new BinaryColumnMetaData<any>(Uint8Array);
            binaryCol.columnName = "binary";
            binaryCol.propertyName = "binary";
            binaryCol.entity = entityMetaData;
            entityMetaData.columns.add(binaryCol);

            const mockConnection = getConnection(db.connection);
            mockConnection.results = [{ "rows": [{ "SCHEMA": "dbo" }], "effectedRows": 1 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "TABLE_TYPE": "BASE TABLE" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "TABLE_TYPE": "BASE TABLE" }], "effectedRows": 2 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": true }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "boolean", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "ORDINAL_POSITION": 3, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "decimal", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 2, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "enum", "ORDINAL_POSITION": 4, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 5, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "ORDINAL_POSITION": 6, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "nullable", "ORDINAL_POSITION": 7, "COLUMN_DEFAULT": null, "IS_NULLABLE": "YES", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "ORDINAL_POSITION": 8, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "real", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 24, "NUMERIC_PRECISION_RADIX": 2, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "rowVersion", "ORDINAL_POSITION": 9, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "timestamp", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "string", "ORDINAL_POSITION": 10, "COLUMN_DEFAULT": "('empty')", "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 150, "CHARACTER_OCTET_LENGTH": 300, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "date", "ORDINAL_POSITION": 11, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "date", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "time", "ORDINAL_POSITION": 12, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 7, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "timeUTC", "ORDINAL_POSITION": 13, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 5, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTime", "ORDINAL_POSITION": 14, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTimeUTC", "ORDINAL_POSITION": 15, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "createdDate", "ORDINAL_POSITION": 16, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "modifiedDate", "ORDINAL_POSITION": 17, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "deleted", "ORDINAL_POSITION": 18, "COLUMN_DEFAULT": "((0))", "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "name", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }], "effectedRows": 20 }, { "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>=(0))" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>[integer])" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "FOREIGN KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }], "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "UNIQUE_CONSTRAINT_CATALOG": "Database", "UNIQUE_CONSTRAINT_SCHEMA": "dbo", "UNIQUE_CONSTRAINT_NAME": "UQ_Schema_identifier", "MATCH_OPTION": "SIMPLE", "UPDATE_RULE": "NO ACTION", "DELETE_RULE": "NO ACTION" }], "effectedRows": 1 }, { "effectedRows": 0 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }], "effectedRows": 9 }, { "rows": [{ "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pid" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pclass" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "thumbprint" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "deleted" }], "effectedRows": 4 }];

            const schemaQuery = await db.getUpdateSchemaQueries([Schema, SubSchema]);

            chai.should();
            schemaQuery.should.deep.equal({
                commit: [
                    { query: "ALTER TABLE [dbo].[Schema] ADD [binary] binary(50) NOT NULL", type: QueryType.DDL }
                ],
                rollback: [
                    { query: "ALTER TABLE [dbo].[Schema] DROP COLUMN [binary]", type: QueryType.DDL, comment: "You might lost your data" }
                ]
            });
        });
        it("should update column", async () => {
            const entityMetaData = Reflect.getOwnMetadata(entityMetaKey, Schema) as IEntityMetaData;
            const columnMeta = entityMetaData.columns.first(o => o.columnName === "binary") as BinaryColumnMetaData;

            columnMeta.default = () => new Uint8Array([0, 12, 40, 12, 0]);
            columnMeta.columnType = "varbinary";
            columnMeta.nullable = true;
            columnMeta.size = 10;

            const mockConnection = getConnection(db.connection);
            mockConnection.results = [
                { "rows": [{ "SCHEMA": "dbo" }], "effectedRows": 1 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "TABLE_TYPE": "BASE TABLE" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "TABLE_TYPE": "BASE TABLE" }], "effectedRows": 2 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": true }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "boolean", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "ORDINAL_POSITION": 3, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "decimal", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 2, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "enum", "ORDINAL_POSITION": 4, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 5, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "ORDINAL_POSITION": 6, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "nullable", "ORDINAL_POSITION": 7, "COLUMN_DEFAULT": null, "IS_NULLABLE": "YES", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "ORDINAL_POSITION": 8, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "real", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 24, "NUMERIC_PRECISION_RADIX": 2, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "rowVersion", "ORDINAL_POSITION": 9, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "timestamp", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "string", "ORDINAL_POSITION": 10, "COLUMN_DEFAULT": "('empty')", "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 150, "CHARACTER_OCTET_LENGTH": 300, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "date", "ORDINAL_POSITION": 11, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "date", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "time", "ORDINAL_POSITION": 12, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 7, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "timeUTC", "ORDINAL_POSITION": 13, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 5, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTime", "ORDINAL_POSITION": 14, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTimeUTC", "ORDINAL_POSITION": 15, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "createdDate", "ORDINAL_POSITION": 16, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "modifiedDate", "ORDINAL_POSITION": 17, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "deleted", "ORDINAL_POSITION": 18, "COLUMN_DEFAULT": "((0))", "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "binary", "ORDINAL_POSITION": 19, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "binary", "CHARACTER_MAXIMUM_LENGTH": 50, "CHARACTER_OCTET_LENGTH": 50, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "name", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }], "effectedRows": 21 }, { "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>=(0))" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>[integer])" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "FOREIGN KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }], "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "UNIQUE_CONSTRAINT_CATALOG": "Database", "UNIQUE_CONSTRAINT_SCHEMA": "dbo", "UNIQUE_CONSTRAINT_NAME": "UQ_Schema_identifier", "MATCH_OPTION": "SIMPLE", "UPDATE_RULE": "NO ACTION", "DELETE_RULE": "NO ACTION" }], "effectedRows": 1 }, { "effectedRows": 0 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }], "effectedRows": 9 }, { "rows": [{ "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pid" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pclass" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "thumbprint" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "deleted" }], "effectedRows": 4 }
            ];

            const schemaQuery = await db.getUpdateSchemaQueries([Schema, SubSchema]);

            chai.should();
            schemaQuery.should.deep.equal({
                commit: [
                    { query: "ALTER TABLE [dbo].[Schema] ALTER COLUMN [binary] varbinary(10)", type: QueryType.DDL },
                    { query: "ALTER TABLE [dbo].[Schema] ADD DEFAULT 0x000c280c00 FOR [binary]", type: QueryType.DDL }
                ],
                rollback: [
                    { query: "DECLARE @param0 nvarchar(255) = ( SELECT dc.name AS ConstraintName FROM sys.default_constraints dc join sys.columns c on dc.parent_object_id = c.object_id and dc.parent_column_id = c.column_id where SCHEMA_NAME(schema_id) = 'dbo' and OBJECT_NAME(parent_object_id) = 'Schema' and c.name = 'binary' )", type: QueryType.DQL },
                    { query: "EXEC('ALTER TABLE [dbo].[Schema] DROP CONSTRAINT [' + @param0 + ']')", type: QueryType.DDL },
                    { query: "UPDATE [dbo].[Schema] SET [binary] = 0x0 WHERE [binary] IS NULL", type: QueryType.DML },
                    { query: "ALTER TABLE [dbo].[Schema] ALTER COLUMN [binary] binary(50) NOT NULL", type: QueryType.DDL }
                ]
            });
        });
        it("should update column 2", async () => {
            // remove default, column type, identity, nullable, and options
            const entityMetaData = Reflect.getOwnMetadata(entityMetaKey, Schema) as IEntityMetaData;
            const columnMeta = entityMetaData.columns.first(o => o.columnName === "binary") as BinaryColumnMetaData;

            columnMeta.default = null;
            columnMeta.columnType = "binary";
            columnMeta.nullable = false;
            columnMeta.size = 100;

            const mockConnection = getConnection(db.connection);
            mockConnection.results = [{ "rows": [{ "SCHEMA": "dbo" }], "effectedRows": 1 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "TABLE_TYPE": "BASE TABLE" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "TABLE_TYPE": "BASE TABLE" }], "effectedRows": 2 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": true }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "boolean", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "ORDINAL_POSITION": 3, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "decimal", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 2, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "enum", "ORDINAL_POSITION": 4, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 5, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "ORDINAL_POSITION": 6, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "nullable", "ORDINAL_POSITION": 7, "COLUMN_DEFAULT": null, "IS_NULLABLE": "YES", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "ORDINAL_POSITION": 8, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "real", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 24, "NUMERIC_PRECISION_RADIX": 2, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "rowVersion", "ORDINAL_POSITION": 9, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "timestamp", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "string", "ORDINAL_POSITION": 10, "COLUMN_DEFAULT": "('empty')", "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 150, "CHARACTER_OCTET_LENGTH": 300, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "date", "ORDINAL_POSITION": 11, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "date", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "time", "ORDINAL_POSITION": 12, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 7, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "timeUTC", "ORDINAL_POSITION": 13, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 5, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTime", "ORDINAL_POSITION": 14, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTimeUTC", "ORDINAL_POSITION": 15, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "createdDate", "ORDINAL_POSITION": 16, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "modifiedDate", "ORDINAL_POSITION": 17, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "deleted", "ORDINAL_POSITION": 18, "COLUMN_DEFAULT": "((0))", "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "binary", "ORDINAL_POSITION": 19, "COLUMN_DEFAULT": "(0x000C280C00)", "IS_NULLABLE": "YES", "DATA_TYPE": "varbinary", "CHARACTER_MAXIMUM_LENGTH": 10, "CHARACTER_OCTET_LENGTH": 10, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "name", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }], "effectedRows": 21 }, { "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>=(0))" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>[integer])" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "FOREIGN KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }], "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "UNIQUE_CONSTRAINT_CATALOG": "Database", "UNIQUE_CONSTRAINT_SCHEMA": "dbo", "UNIQUE_CONSTRAINT_NAME": "UQ_Schema_identifier", "MATCH_OPTION": "SIMPLE", "UPDATE_RULE": "NO ACTION", "DELETE_RULE": "NO ACTION" }], "effectedRows": 1 }, { "effectedRows": 0 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }], "effectedRows": 9 }, { "rows": [{ "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pid" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pclass" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "thumbprint" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "deleted" }], "effectedRows": 4 }];

            const schemaQuery = await db.getUpdateSchemaQueries([Schema, SubSchema]);

            chai.should();
            schemaQuery.should.deep.include({
                commit: [
                    { query: "DECLARE @param0 nvarchar(255) = ( SELECT dc.name AS ConstraintName FROM sys.default_constraints dc join sys.columns c on dc.parent_object_id = c.object_id and dc.parent_column_id = c.column_id where SCHEMA_NAME(schema_id) = 'dbo' and OBJECT_NAME(parent_object_id) = 'Schema' and c.name = 'binary' )", type: QueryType.DQL },
                    { query: "EXEC('ALTER TABLE [dbo].[Schema] DROP CONSTRAINT [' + @param0 + ']')", type: QueryType.DDL },
                    { query: "UPDATE [dbo].[Schema] SET [binary] = 0x0 WHERE [binary] IS NULL", type: QueryType.DML },
                    { query: "ALTER TABLE [dbo].[Schema] ALTER COLUMN [binary] binary(100) NOT NULL", type: QueryType.DDL }
                ],
                rollback: [
                    { query: "ALTER TABLE [dbo].[Schema] ALTER COLUMN [binary] varbinary(10)", type: QueryType.DDL },
                    { query: "ALTER TABLE [dbo].[Schema] ADD DEFAULT 0x000C280C00 FOR [binary]", type: QueryType.DDL }
                ]
            });
        });
        it("should update column 3", async () => {
            const entityMetaData = Reflect.getOwnMetadata(entityMetaKey, Schema) as IEntityMetaData;
            const columnMeta = entityMetaData.columns.first(o => o.columnName === "binary") as BinaryColumnMetaData;

            columnMeta.default = null;
            columnMeta.columnType = "binary";
            columnMeta.nullable = false;
            columnMeta.size = 100;

            const mockConnection = getConnection(db.connection);
            mockConnection.results = [{ "rows": [{ "SCHEMA": "dbo" }], "effectedRows": 1 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "TABLE_TYPE": "BASE TABLE" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "TABLE_TYPE": "BASE TABLE" }], "effectedRows": 2 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": true }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "boolean", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "ORDINAL_POSITION": 3, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "decimal", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 2, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "enum", "ORDINAL_POSITION": 4, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 5, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "ORDINAL_POSITION": 6, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "nullable", "ORDINAL_POSITION": 7, "COLUMN_DEFAULT": null, "IS_NULLABLE": "YES", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "ORDINAL_POSITION": 8, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "real", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 24, "NUMERIC_PRECISION_RADIX": 2, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "rowVersion", "ORDINAL_POSITION": 9, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "timestamp", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "string", "ORDINAL_POSITION": 10, "COLUMN_DEFAULT": "('empty')", "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 150, "CHARACTER_OCTET_LENGTH": 300, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "date", "ORDINAL_POSITION": 11, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "date", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "time", "ORDINAL_POSITION": 12, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 7, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "timeUTC", "ORDINAL_POSITION": 13, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 5, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTime", "ORDINAL_POSITION": 14, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTimeUTC", "ORDINAL_POSITION": 15, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "createdDate", "ORDINAL_POSITION": 16, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "modifiedDate", "ORDINAL_POSITION": 17, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "deleted", "ORDINAL_POSITION": 18, "COLUMN_DEFAULT": "((0))", "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "binary", "ORDINAL_POSITION": 19, "COLUMN_DEFAULT": "(0x000C280C00)", "IS_NULLABLE": "YES", "DATA_TYPE": "varbinary", "CHARACTER_MAXIMUM_LENGTH": 10, "CHARACTER_OCTET_LENGTH": 10, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "name", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }], "effectedRows": 21 }, { "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>=(0))" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>[integer])" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "FOREIGN KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }], "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "UNIQUE_CONSTRAINT_CATALOG": "Database", "UNIQUE_CONSTRAINT_SCHEMA": "dbo", "UNIQUE_CONSTRAINT_NAME": "UQ_Schema_identifier", "MATCH_OPTION": "SIMPLE", "UPDATE_RULE": "NO ACTION", "DELETE_RULE": "NO ACTION" }], "effectedRows": 1 }, { "effectedRows": 0 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }], "effectedRows": 9 }, { "rows": [{ "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pid" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pclass" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "thumbprint" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "deleted" }], "effectedRows": 4 }];

            const schemaQuery = await db.getUpdateSchemaQueries([Schema, SubSchema]);

            chai.should();
            schemaQuery.should.deep.include({
                commit: [
                    { query: "DECLARE @param0 nvarchar(255) = ( SELECT dc.name AS ConstraintName FROM sys.default_constraints dc join sys.columns c on dc.parent_object_id = c.object_id and dc.parent_column_id = c.column_id where SCHEMA_NAME(schema_id) = 'dbo' and OBJECT_NAME(parent_object_id) = 'Schema' and c.name = 'binary' )", type: QueryType.DQL },
                    { query: "EXEC('ALTER TABLE [dbo].[Schema] DROP CONSTRAINT [' + @param0 + ']')", type: QueryType.DDL },
                    { query: "UPDATE [dbo].[Schema] SET [binary] = 0x0 WHERE [binary] IS NULL", type: QueryType.DML },
                    { query: "ALTER TABLE [dbo].[Schema] ALTER COLUMN [binary] binary(100) NOT NULL", type: QueryType.DDL }
                ],
                rollback: [
                    { query: "ALTER TABLE [dbo].[Schema] ALTER COLUMN [binary] varbinary(10)", type: QueryType.DDL },
                    { query: "ALTER TABLE [dbo].[Schema] ADD DEFAULT 0x000C280C00 FOR [binary]", type: QueryType.DDL }
                ]
            });
        });
        it("should remove column", async () => {
            const entityMetaData = Reflect.getOwnMetadata(entityMetaKey, Schema) as IEntityMetaData;
            const columnMeta = entityMetaData.columns.first(o => o.columnName === "binary") as BinaryColumnMetaData;
            entityMetaData.columns.delete(columnMeta);

            const mockConnection = getConnection(db.connection);
            mockConnection.results = [{ "rows": [{ "SCHEMA": "dbo" }], "effectedRows": 1 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "TABLE_TYPE": "BASE TABLE" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "TABLE_TYPE": "BASE TABLE" }], "effectedRows": 2 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": true }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "boolean", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "ORDINAL_POSITION": 3, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "decimal", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 2, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "enum", "ORDINAL_POSITION": 4, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 5, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "ORDINAL_POSITION": 6, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "nullable", "ORDINAL_POSITION": 7, "COLUMN_DEFAULT": null, "IS_NULLABLE": "YES", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "ORDINAL_POSITION": 8, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "real", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 24, "NUMERIC_PRECISION_RADIX": 2, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "rowVersion", "ORDINAL_POSITION": 9, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "timestamp", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "string", "ORDINAL_POSITION": 10, "COLUMN_DEFAULT": "('empty')", "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 150, "CHARACTER_OCTET_LENGTH": 300, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "date", "ORDINAL_POSITION": 11, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "date", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "time", "ORDINAL_POSITION": 12, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 7, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "timeUTC", "ORDINAL_POSITION": 13, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 5, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTime", "ORDINAL_POSITION": 14, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTimeUTC", "ORDINAL_POSITION": 15, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "createdDate", "ORDINAL_POSITION": 16, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "modifiedDate", "ORDINAL_POSITION": 17, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "deleted", "ORDINAL_POSITION": 18, "COLUMN_DEFAULT": "((0))", "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "binary", "ORDINAL_POSITION": 19, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "binary", "CHARACTER_MAXIMUM_LENGTH": 100, "CHARACTER_OCTET_LENGTH": 100, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "name", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }], "effectedRows": 21 }, { "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>=(0))" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>[integer])" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "FOREIGN KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }], "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "UNIQUE_CONSTRAINT_CATALOG": "Database", "UNIQUE_CONSTRAINT_SCHEMA": "dbo", "UNIQUE_CONSTRAINT_NAME": "UQ_Schema_identifier", "MATCH_OPTION": "SIMPLE", "UPDATE_RULE": "NO ACTION", "DELETE_RULE": "NO ACTION" }], "effectedRows": 1 }, { "effectedRows": 0 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }], "effectedRows": 9 }, { "rows": [{ "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pid" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pclass" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "thumbprint" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "deleted" }], "effectedRows": 4 }];

            const schemaQuery = await db.getUpdateSchemaQueries([Schema, SubSchema]);

            chai.should();
            schemaQuery.should.deep.equal({
                commit: [
                    { query: "ALTER TABLE [dbo].[Schema] DROP COLUMN [binary]", type: QueryType.DDL, comment: "You might lost your data" }
                ],
                rollback: [
                    { query: "ALTER TABLE [dbo].[Schema] ADD [binary] binary(100) NOT NULL", type: QueryType.DDL }
                ]
            });
        });
        it("should change auto increement column", async () => {
            const entityMetaData = Reflect.getOwnMetadata(entityMetaKey, Schema) as IEntityMetaData;
            const columnMeta = entityMetaData.columns.ofType(IntegerColumnMetaData).where(o => o.autoIncrement).first();
            columnMeta.autoIncrement = false;

            const mockConnection = getConnection(db.connection);
            mockConnection.results = [{ "rows": [{ "SCHEMA": "dbo" }], "effectedRows": 1 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "TABLE_TYPE": "BASE TABLE" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "TABLE_TYPE": "BASE TABLE" }], "effectedRows": 2 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": true }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "boolean", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "ORDINAL_POSITION": 3, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "decimal", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 2, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "enum", "ORDINAL_POSITION": 4, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 5, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "ORDINAL_POSITION": 6, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "nullable", "ORDINAL_POSITION": 7, "COLUMN_DEFAULT": null, "IS_NULLABLE": "YES", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "ORDINAL_POSITION": 8, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "real", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 24, "NUMERIC_PRECISION_RADIX": 2, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "rowVersion", "ORDINAL_POSITION": 9, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "timestamp", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "string", "ORDINAL_POSITION": 10, "COLUMN_DEFAULT": "('empty')", "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 150, "CHARACTER_OCTET_LENGTH": 300, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "date", "ORDINAL_POSITION": 11, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "date", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "time", "ORDINAL_POSITION": 12, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 7, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "timeUTC", "ORDINAL_POSITION": 13, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 5, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTime", "ORDINAL_POSITION": 14, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTimeUTC", "ORDINAL_POSITION": 15, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "createdDate", "ORDINAL_POSITION": 16, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "modifiedDate", "ORDINAL_POSITION": 17, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "deleted", "ORDINAL_POSITION": 18, "COLUMN_DEFAULT": "((0))", "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "name", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }], "effectedRows": 20 }, { "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>=(0))" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>[integer])" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "FOREIGN KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }], "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "UNIQUE_CONSTRAINT_CATALOG": "Database", "UNIQUE_CONSTRAINT_SCHEMA": "dbo", "UNIQUE_CONSTRAINT_NAME": "UQ_Schema_identifier", "MATCH_OPTION": "SIMPLE", "UPDATE_RULE": "NO ACTION", "DELETE_RULE": "NO ACTION" }], "effectedRows": 1 }, { "effectedRows": 0 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }], "effectedRows": 9 }, { "rows": [{ "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pid" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pclass" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "thumbprint" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "deleted" }], "effectedRows": 4 }];

            const schemaQuery = await db.getUpdateSchemaQueries([Schema, SubSchema]);

            chai.should();
            schemaQuery.should.deep.equal({
                commit: [
                    { query: "ALTER TABLE [dbo].[Schema] ADD [NEW_primaryKey] int NOT NULL", type: QueryType.DDL },
                    { query: "EXEC('UPDATE [dbo].[Schema] WITH (HOLDLOCK TABLOCKX) SET [NEW_primaryKey] = [primaryKey]')", type: QueryType.DML },
                    { query: "ALTER TABLE [dbo].[Schema] DROP COLUMN [primaryKey]", type: QueryType.DDL, "comment": "You might lost your data" },
                    { query: "EXEC sp_rename '[dbo].[Schema].[NEW_primaryKey]', 'primaryKey', 'COLUMN'", type: QueryType.DDL }
                ],
                rollback: [
                    { query: "ALTER TABLE [dbo].[Schema] ADD [NEW_primaryKey] int NOT NULL IDENTITY(1,1)", type: QueryType.DDL },
                    { query: "SET IDENTITY_INSERT [dbo].[Schema] ON", type: QueryType.DCL },
                    { query: "EXEC('UPDATE [dbo].[Schema] WITH (HOLDLOCK TABLOCKX) SET [NEW_primaryKey] = [primaryKey]')", type: QueryType.DML },
                    { query: "SET IDENTITY_INSERT [dbo].[Schema] OFF", type: QueryType.DCL },
                    { query: "ALTER TABLE [dbo].[Schema] DROP COLUMN [primaryKey]", type: QueryType.DDL, "comment": "You might lost your data" },
                    { query: "EXEC sp_rename '[dbo].[Schema].[NEW_primaryKey]', 'primaryKey', 'COLUMN'", type: QueryType.DDL }
                ]
            });

            columnMeta.autoIncrement = true;
        });
    });
    describe("INDEX", () => {
        it("should add multi columns index", async () => {
            // index defined in entity and column
            const indexFactory = ColumnIndex<Schema>({ properties: [o => o.createdDate, "modifiedDate"], unique: true });
            indexFactory(Schema);

            const mockConnection = getConnection(db.connection);
            mockConnection.results = [{ "rows": [{ "SCHEMA": "dbo" }], "effectedRows": 1 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "TABLE_TYPE": "BASE TABLE" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "TABLE_TYPE": "BASE TABLE" }], "effectedRows": 2 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": true }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "boolean", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "ORDINAL_POSITION": 3, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "decimal", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 2, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "enum", "ORDINAL_POSITION": 4, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 5, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "ORDINAL_POSITION": 6, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "nullable", "ORDINAL_POSITION": 7, "COLUMN_DEFAULT": null, "IS_NULLABLE": "YES", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "ORDINAL_POSITION": 8, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "real", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 24, "NUMERIC_PRECISION_RADIX": 2, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "rowVersion", "ORDINAL_POSITION": 9, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "timestamp", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "string", "ORDINAL_POSITION": 10, "COLUMN_DEFAULT": "('empty')", "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 150, "CHARACTER_OCTET_LENGTH": 300, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "date", "ORDINAL_POSITION": 11, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "date", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "time", "ORDINAL_POSITION": 12, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 7, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "timeUTC", "ORDINAL_POSITION": 13, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 5, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTime", "ORDINAL_POSITION": 14, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTimeUTC", "ORDINAL_POSITION": 15, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "createdDate", "ORDINAL_POSITION": 16, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "modifiedDate", "ORDINAL_POSITION": 17, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "deleted", "ORDINAL_POSITION": 18, "COLUMN_DEFAULT": "((0))", "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "name", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }], "effectedRows": 20 }, { "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>=(0))" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>[integer])" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "FOREIGN KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }], "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "UNIQUE_CONSTRAINT_CATALOG": "Database", "UNIQUE_CONSTRAINT_SCHEMA": "dbo", "UNIQUE_CONSTRAINT_NAME": "UQ_Schema_identifier", "MATCH_OPTION": "SIMPLE", "UPDATE_RULE": "NO ACTION", "DELETE_RULE": "NO ACTION" }], "effectedRows": 1 }, { "effectedRows": 0 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }], "effectedRows": 9 }, { "rows": [{ "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pid" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pclass" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "thumbprint" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "deleted" }], "effectedRows": 4 }];

            const schemaQuery = await db.getUpdateSchemaQueries([Schema, SubSchema]);

            chai.should();
            schemaQuery.should.deep.equal({
                commit: [
                    { query: "CREATE UNIQUE INDEX IX_createdDate_modifiedDate ON [dbo].[Schema] ([createdDate],[modifiedDate])", type: QueryType.DDL }
                ],
                rollback: [
                    { query: "DROP INDEX [dbo].[Schema].IX_createdDate_modifiedDate", type: QueryType.DDL }
                ]
            });

            // remove added index
            const entityMetaData = Reflect.getOwnMetadata(entityMetaKey, Schema) as IEntityMetaData;
            entityMetaData.indices.length--;
        });
        it("should remove index", async () => {
            const entityMetaData = Reflect.getOwnMetadata(entityMetaKey, Schema) as IEntityMetaData;
            const index = entityMetaData.indices.first();
            entityMetaData.indices.delete(index);

            const mockConnection = getConnection(db.connection);
            mockConnection.results = [{ "rows": [{ "SCHEMA": "dbo" }], "effectedRows": 1 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "TABLE_TYPE": "BASE TABLE" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "TABLE_TYPE": "BASE TABLE" }], "effectedRows": 2 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": true }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "boolean", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "ORDINAL_POSITION": 3, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "decimal", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 2, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "enum", "ORDINAL_POSITION": 4, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 5, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "ORDINAL_POSITION": 6, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "nullable", "ORDINAL_POSITION": 7, "COLUMN_DEFAULT": null, "IS_NULLABLE": "YES", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "ORDINAL_POSITION": 8, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "real", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 24, "NUMERIC_PRECISION_RADIX": 2, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "rowVersion", "ORDINAL_POSITION": 9, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "timestamp", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "string", "ORDINAL_POSITION": 10, "COLUMN_DEFAULT": "('empty')", "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 150, "CHARACTER_OCTET_LENGTH": 300, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "date", "ORDINAL_POSITION": 11, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "date", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "time", "ORDINAL_POSITION": 12, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 7, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "timeUTC", "ORDINAL_POSITION": 13, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 5, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTime", "ORDINAL_POSITION": 14, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTimeUTC", "ORDINAL_POSITION": 15, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "createdDate", "ORDINAL_POSITION": 16, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "modifiedDate", "ORDINAL_POSITION": 17, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "deleted", "ORDINAL_POSITION": 18, "COLUMN_DEFAULT": "((0))", "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "name", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }], "effectedRows": 20 }, { "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>=(0))" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>[integer])" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "FOREIGN KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }], "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "UNIQUE_CONSTRAINT_CATALOG": "Database", "UNIQUE_CONSTRAINT_SCHEMA": "dbo", "UNIQUE_CONSTRAINT_NAME": "UQ_Schema_identifier", "MATCH_OPTION": "SIMPLE", "UPDATE_RULE": "NO ACTION", "DELETE_RULE": "NO ACTION" }], "effectedRows": 1 }, { "effectedRows": 0 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }], "effectedRows": 9 }, { "rows": [{ "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pid" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pclass" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "thumbprint" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "deleted" }], "effectedRows": 4 }];

            const schemaQuery = await db.getUpdateSchemaQueries([Schema, SubSchema]);

            chai.should();
            schemaQuery.should.deep.equal({
                commit: [
                    { query: "DROP INDEX [dbo].[Schema].IX_deleted", type: QueryType.DDL }
                ],
                rollback: [
                    { query: "CREATE INDEX IX_deleted ON [dbo].[Schema] ([deleted])", type: QueryType.DDL }
                ]
            });

            entityMetaData.indices.push(index);
        });
    });
    describe("CHECK CONSTRAINT", () => {
        it("should update check", async () => {
            // index defined in entity and column
            const entityMetaData = Reflect.getOwnMetadata(entityMetaKey, Schema) as IEntityMetaData<Schema, any>;
            const check = entityMetaData.constraints.ofType<CheckConstraintMetaData<Schema>>(CheckConstraintMetaData).first(o => o.name === "Schema_entity_check");
            const modifiedCheck = new CheckConstraintMetaData(check.name, check.entity, (entity: Schema) => entity.decimal < entity.integer);
            entityMetaData.constraints.delete(check);
            entityMetaData.constraints.push(modifiedCheck);

            const mockConnection = getConnection(db.connection);
            mockConnection.results = [{ "rows": [{ "SCHEMA": "dbo" }], "effectedRows": 1 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "TABLE_TYPE": "BASE TABLE" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "TABLE_TYPE": "BASE TABLE" }], "effectedRows": 2 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": true }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "boolean", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "ORDINAL_POSITION": 3, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "decimal", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 2, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "enum", "ORDINAL_POSITION": 4, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 5, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "ORDINAL_POSITION": 6, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "nullable", "ORDINAL_POSITION": 7, "COLUMN_DEFAULT": null, "IS_NULLABLE": "YES", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "ORDINAL_POSITION": 8, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "real", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 24, "NUMERIC_PRECISION_RADIX": 2, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "rowVersion", "ORDINAL_POSITION": 9, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "timestamp", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "string", "ORDINAL_POSITION": 10, "COLUMN_DEFAULT": "('empty')", "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 150, "CHARACTER_OCTET_LENGTH": 300, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "date", "ORDINAL_POSITION": 11, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "date", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "time", "ORDINAL_POSITION": 12, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 7, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "timeUTC", "ORDINAL_POSITION": 13, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 5, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTime", "ORDINAL_POSITION": 14, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTimeUTC", "ORDINAL_POSITION": 15, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "createdDate", "ORDINAL_POSITION": 16, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "modifiedDate", "ORDINAL_POSITION": 17, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "deleted", "ORDINAL_POSITION": 18, "COLUMN_DEFAULT": "((0))", "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "name", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }], "effectedRows": 20 }, { "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>=(0))" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>[integer])" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "FOREIGN KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }], "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "UNIQUE_CONSTRAINT_CATALOG": "Database", "UNIQUE_CONSTRAINT_SCHEMA": "dbo", "UNIQUE_CONSTRAINT_NAME": "UQ_Schema_identifier", "MATCH_OPTION": "SIMPLE", "UPDATE_RULE": "NO ACTION", "DELETE_RULE": "NO ACTION" }], "effectedRows": 1 }, { "effectedRows": 0 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }], "effectedRows": 9 }, { "rows": [{ "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pid" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pclass" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "thumbprint" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "deleted" }], "effectedRows": 4 }];

            const schemaQuery = await db.getUpdateSchemaQueries([Schema, SubSchema]);

            chai.should();
            schemaQuery.should.deep.equal({
                "commit": [
                    { query: "ALTER TABLE [dbo].[Schema] DROP CONSTRAINT [Schema_entity_check]", type: 4 },
                    { query: "ALTER TABLE [dbo].[Schema] ADD CONSTRAINT CONSTRAINT [Schema_entity_check] CHECK (([decimal]<[integer]))", type: 4 }
                ],
                "rollback": [
                    { query: "ALTER TABLE [dbo].[Schema] DROP CONSTRAINT [Schema_entity_check]", type: 4 },
                    { query: "ALTER TABLE [dbo].[Schema] ADD CONSTRAINT CONSTRAINT [Schema_entity_check] CHECK (([decimal]>[integer]))", type: 4 }
                ]
            });

            entityMetaData.constraints.push(check);
            entityMetaData.constraints.delete(modifiedCheck);
        });
        it("should remove check", async () => {
            const entityMetaData = Reflect.getOwnMetadata(entityMetaKey, Schema) as IEntityMetaData;
            const check = entityMetaData.constraints.ofType(CheckConstraintMetaData).first(o => o.name !== "Schema_entity_check");
            entityMetaData.constraints.delete(check);

            const mockConnection = getConnection(db.connection);
            mockConnection.results = [{ "rows": [{ "SCHEMA": "dbo" }], "effectedRows": 1 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "TABLE_TYPE": "BASE TABLE" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "TABLE_TYPE": "BASE TABLE" }], "effectedRows": 2 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": true }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "boolean", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "ORDINAL_POSITION": 3, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "decimal", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 2, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "enum", "ORDINAL_POSITION": 4, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 5, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "ORDINAL_POSITION": 6, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "nullable", "ORDINAL_POSITION": 7, "COLUMN_DEFAULT": null, "IS_NULLABLE": "YES", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "ORDINAL_POSITION": 8, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "real", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 24, "NUMERIC_PRECISION_RADIX": 2, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "rowVersion", "ORDINAL_POSITION": 9, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "timestamp", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "string", "ORDINAL_POSITION": 10, "COLUMN_DEFAULT": "('empty')", "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 150, "CHARACTER_OCTET_LENGTH": 300, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "date", "ORDINAL_POSITION": 11, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "date", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "time", "ORDINAL_POSITION": 12, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 7, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "timeUTC", "ORDINAL_POSITION": 13, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 5, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTime", "ORDINAL_POSITION": 14, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTimeUTC", "ORDINAL_POSITION": 15, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "createdDate", "ORDINAL_POSITION": 16, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "modifiedDate", "ORDINAL_POSITION": 17, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "deleted", "ORDINAL_POSITION": 18, "COLUMN_DEFAULT": "((0))", "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "name", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }], "effectedRows": 20 }, { "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>=(0))" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>[integer])" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "FOREIGN KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }], "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "UNIQUE_CONSTRAINT_CATALOG": "Database", "UNIQUE_CONSTRAINT_SCHEMA": "dbo", "UNIQUE_CONSTRAINT_NAME": "UQ_Schema_identifier", "MATCH_OPTION": "SIMPLE", "UPDATE_RULE": "NO ACTION", "DELETE_RULE": "NO ACTION" }], "effectedRows": 1 }, { "effectedRows": 0 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }], "effectedRows": 9 }, { "rows": [{ "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pid" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pclass" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "thumbprint" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "deleted" }], "effectedRows": 4 }];

            const schemaQuery = await db.getUpdateSchemaQueries([Schema, SubSchema]);

            chai.should();
            schemaQuery.should.deep.equal({
                "commit": [
                    { query: "ALTER TABLE [dbo].[Schema] DROP CONSTRAINT [CK_Schema_decimal]", type: 4 }
                ],
                "rollback": [
                    { query: "ALTER TABLE [dbo].[Schema] ADD CONSTRAINT CONSTRAINT [CK_Schema_decimal] CHECK (([decimal]>=(0)))", type: 4 }
                ]
            });

            entityMetaData.constraints.push(check);
        });
    });
    describe("UNIQUE CONSTRAINT", () => {
        it("should update unique", async () => {
            const entityMetaData = Reflect.getOwnMetadata(entityMetaKey, Schema) as IEntityMetaData;
            const unique = entityMetaData.constraints.ofType(UniqueConstraintMetaData).first(o => o.name === "Schema_entity_unique");
            const modifiedUnique = new UniqueConstraintMetaData(unique.name, unique.entity, unique.columns.slice(1));
            entityMetaData.constraints.delete(unique);
            entityMetaData.constraints.push(modifiedUnique);

            const mockConnection = getConnection(db.connection);
            mockConnection.results = [{ "rows": [{ "SCHEMA": "dbo" }], "effectedRows": 1 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "TABLE_TYPE": "BASE TABLE" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "TABLE_TYPE": "BASE TABLE" }], "effectedRows": 2 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": true }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "boolean", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "ORDINAL_POSITION": 3, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "decimal", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 2, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "enum", "ORDINAL_POSITION": 4, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 5, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "ORDINAL_POSITION": 6, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "nullable", "ORDINAL_POSITION": 7, "COLUMN_DEFAULT": null, "IS_NULLABLE": "YES", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "ORDINAL_POSITION": 8, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "real", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 24, "NUMERIC_PRECISION_RADIX": 2, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "rowVersion", "ORDINAL_POSITION": 9, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "timestamp", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "string", "ORDINAL_POSITION": 10, "COLUMN_DEFAULT": "('empty')", "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 150, "CHARACTER_OCTET_LENGTH": 300, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "date", "ORDINAL_POSITION": 11, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "date", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "time", "ORDINAL_POSITION": 12, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 7, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "timeUTC", "ORDINAL_POSITION": 13, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 5, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTime", "ORDINAL_POSITION": 14, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTimeUTC", "ORDINAL_POSITION": 15, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "createdDate", "ORDINAL_POSITION": 16, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "modifiedDate", "ORDINAL_POSITION": 17, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "deleted", "ORDINAL_POSITION": 18, "COLUMN_DEFAULT": "((0))", "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "name", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }], "effectedRows": 20 }, { "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>=(0))" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>[integer])" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "FOREIGN KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }], "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "UNIQUE_CONSTRAINT_CATALOG": "Database", "UNIQUE_CONSTRAINT_SCHEMA": "dbo", "UNIQUE_CONSTRAINT_NAME": "UQ_Schema_identifier", "MATCH_OPTION": "SIMPLE", "UPDATE_RULE": "NO ACTION", "DELETE_RULE": "NO ACTION" }], "effectedRows": 1 }, { "effectedRows": 0 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }], "effectedRows": 9 }, { "rows": [{ "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pid" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pclass" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "thumbprint" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "deleted" }], "effectedRows": 4 }];

            const schemaQuery = await db.getUpdateSchemaQueries([Schema, SubSchema]);

            chai.should();
            schemaQuery.should.deep.equal({
                "commit": [
                    { query: "ALTER TABLE [dbo].[Schema] DROP CONSTRAINT [Schema_entity_unique]", type: 4 },
                    { query: "ALTER TABLE [dbo].[Schema] ADD CONSTRAINT CONSTRAINT [Schema_entity_unique] UNIQUE ([real])", type: 4 }
                ],
                "rollback": [
                    { query: "ALTER TABLE [dbo].[Schema] DROP CONSTRAINT [Schema_entity_unique]", type: 4 },
                    { query: "ALTER TABLE [dbo].[Schema] ADD CONSTRAINT CONSTRAINT [Schema_entity_unique] UNIQUE ([decimal],[real])", type: 4 }
                ]
            });

            entityMetaData.constraints.push(unique);
            entityMetaData.constraints.delete(modifiedUnique);
        });
        it("should remove unique", async () => {
            const entityMetaData = Reflect.getOwnMetadata(entityMetaKey, Schema) as IEntityMetaData;
            const unique = entityMetaData.constraints.ofType(UniqueConstraintMetaData).first(o => o.name !== "Schema_entity_unique");
            entityMetaData.constraints.delete(unique);

            const mockConnection = getConnection(db.connection);
            mockConnection.results = [{ "rows": [{ "SCHEMA": "dbo" }], "effectedRows": 1 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "TABLE_TYPE": "BASE TABLE" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "TABLE_TYPE": "BASE TABLE" }], "effectedRows": 2 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": true }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "boolean", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "ORDINAL_POSITION": 3, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "decimal", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 2, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "enum", "ORDINAL_POSITION": 4, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 5, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "ORDINAL_POSITION": 6, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "nullable", "ORDINAL_POSITION": 7, "COLUMN_DEFAULT": null, "IS_NULLABLE": "YES", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "ORDINAL_POSITION": 8, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "real", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 24, "NUMERIC_PRECISION_RADIX": 2, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "rowVersion", "ORDINAL_POSITION": 9, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "timestamp", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "string", "ORDINAL_POSITION": 10, "COLUMN_DEFAULT": "('empty')", "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 150, "CHARACTER_OCTET_LENGTH": 300, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "date", "ORDINAL_POSITION": 11, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "date", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "time", "ORDINAL_POSITION": 12, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 7, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "timeUTC", "ORDINAL_POSITION": 13, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 5, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTime", "ORDINAL_POSITION": 14, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTimeUTC", "ORDINAL_POSITION": 15, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "createdDate", "ORDINAL_POSITION": 16, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "modifiedDate", "ORDINAL_POSITION": 17, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "deleted", "ORDINAL_POSITION": 18, "COLUMN_DEFAULT": "((0))", "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "name", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }], "effectedRows": 20 }, { "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>=(0))" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>[integer])" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "FOREIGN KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }], "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "UNIQUE_CONSTRAINT_CATALOG": "Database", "UNIQUE_CONSTRAINT_SCHEMA": "dbo", "UNIQUE_CONSTRAINT_NAME": "UQ_Schema_identifier", "MATCH_OPTION": "SIMPLE", "UPDATE_RULE": "NO ACTION", "DELETE_RULE": "NO ACTION" }], "effectedRows": 1 }, { "effectedRows": 0 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }], "effectedRows": 9 }, { "rows": [{ "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pid" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pclass" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "thumbprint" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "deleted" }], "effectedRows": 4 }];

            const schemaQuery = await db.getUpdateSchemaQueries([Schema, SubSchema]);

            chai.should();
            schemaQuery.should.deep.equal({
                "commit": [
                    { query: "ALTER TABLE [dbo].[Schema] DROP CONSTRAINT [UQ_Schema_identifier]", type: 4 }
                ],
                "rollback": [
                    { query: "ALTER TABLE [dbo].[Schema] ADD CONSTRAINT CONSTRAINT [UQ_Schema_identifier] UNIQUE ([identifier])", type: 4 }
                ]
            });

            entityMetaData.constraints.push(unique);
        });
    });
    describe("RELATION", () => {
        it("should update relation", async () => {
            const entityMetaData = Reflect.getOwnMetadata(entityMetaKey, Schema) as IEntityMetaData;
            const relationMeta = entityMetaData.relations.first();
            const oldRelCols = relationMeta.relationColumns;
            relationMeta.relationColumns = entityMetaData.columns.where(o => o.columnName === "primaryKey").toArray();
            relationMeta.completeRelation(relationMeta.reverseRelation);

            const mockConnection = getConnection(db.connection);
            mockConnection.results = [{ "rows": [{ "SCHEMA": "dbo" }], "effectedRows": 1 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "TABLE_TYPE": "BASE TABLE" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "TABLE_TYPE": "BASE TABLE" }], "effectedRows": 2 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": true }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "boolean", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "ORDINAL_POSITION": 3, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "decimal", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 2, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "enum", "ORDINAL_POSITION": 4, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 5, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "ORDINAL_POSITION": 6, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "nullable", "ORDINAL_POSITION": 7, "COLUMN_DEFAULT": null, "IS_NULLABLE": "YES", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "ORDINAL_POSITION": 8, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "real", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 24, "NUMERIC_PRECISION_RADIX": 2, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "rowVersion", "ORDINAL_POSITION": 9, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "timestamp", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "string", "ORDINAL_POSITION": 10, "COLUMN_DEFAULT": "('empty')", "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 150, "CHARACTER_OCTET_LENGTH": 300, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "date", "ORDINAL_POSITION": 11, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "date", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "time", "ORDINAL_POSITION": 12, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 7, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "timeUTC", "ORDINAL_POSITION": 13, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 5, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTime", "ORDINAL_POSITION": 14, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTimeUTC", "ORDINAL_POSITION": 15, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "createdDate", "ORDINAL_POSITION": 16, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "modifiedDate", "ORDINAL_POSITION": 17, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "deleted", "ORDINAL_POSITION": 18, "COLUMN_DEFAULT": "((0))", "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "name", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }], "effectedRows": 20 }, { "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>=(0))" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>[integer])" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "FOREIGN KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }], "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "UNIQUE_CONSTRAINT_CATALOG": "Database", "UNIQUE_CONSTRAINT_SCHEMA": "dbo", "UNIQUE_CONSTRAINT_NAME": "UQ_Schema_identifier", "MATCH_OPTION": "SIMPLE", "UPDATE_RULE": "NO ACTION", "DELETE_RULE": "NO ACTION" }], "effectedRows": 1 }, { "effectedRows": 0 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }], "effectedRows": 9 }, { "rows": [{ "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pid" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pclass" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "thumbprint" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "deleted" }], "effectedRows": 4 }];

            const schemaQuery = await db.getUpdateSchemaQueries([Schema, SubSchema]);

            chai.should();
            schemaQuery.should.deep.equal({
                "commit": [
                    { query: "ALTER TABLE [dbo].[SubSchema] DROP CONSTRAINT [own_Schema_SubSchema]", type: 4 },
                    { query: "ALTER TABLE [dbo].[SubSchema] ADD CONSTRAINT [own_Schema_SubSchema] FOREIGN KEY ([identifier]) REFERENCES [dbo].[Schema] ([primaryKey])", type: 4 }
                ],
                "rollback": [
                    { query: "ALTER TABLE [dbo].[SubSchema] DROP CONSTRAINT [own_Schema_SubSchema]", type: 4 },
                    { query: "ALTER TABLE [dbo].[SubSchema] ADD CONSTRAINT [own_Schema_SubSchema] FOREIGN KEY ([identifier]) REFERENCES [dbo].[Schema] ([identifier])", type: 4 }
                ]
            });

            relationMeta.relationColumns = oldRelCols;
            relationMeta.completeRelation(relationMeta.reverseRelation);
        });
        it("should remove fk", async () => {
            const entityMetaData = Reflect.getOwnMetadata(entityMetaKey, SubSchema) as IEntityMetaData;
            const relationMeta = entityMetaData.relations.first(o => !o.isMaster);
            entityMetaData.relations.delete(relationMeta);

            const mockConnection = getConnection(db.connection!);
            mockConnection.results = [{ "rows": [{ "SCHEMA": "dbo" }], "effectedRows": 1 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "TABLE_TYPE": "BASE TABLE" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "TABLE_TYPE": "BASE TABLE" }], "effectedRows": 2 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": true }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "boolean", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "ORDINAL_POSITION": 3, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "decimal", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 2, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "enum", "ORDINAL_POSITION": 4, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 5, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "ORDINAL_POSITION": 6, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "int", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 10, "NUMERIC_PRECISION_RADIX": 10, "NUMERIC_SCALE": 0, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "nullable", "ORDINAL_POSITION": 7, "COLUMN_DEFAULT": null, "IS_NULLABLE": "YES", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "ORDINAL_POSITION": 8, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "real", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": 24, "NUMERIC_PRECISION_RADIX": 2, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "rowVersion", "ORDINAL_POSITION": 9, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "timestamp", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "string", "ORDINAL_POSITION": 10, "COLUMN_DEFAULT": "('empty')", "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 150, "CHARACTER_OCTET_LENGTH": 300, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "date", "ORDINAL_POSITION": 11, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "date", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "time", "ORDINAL_POSITION": 12, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 7, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "timeUTC", "ORDINAL_POSITION": 13, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "time", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 5, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTime", "ORDINAL_POSITION": 14, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "dateTimeUTC", "ORDINAL_POSITION": 15, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "createdDate", "ORDINAL_POSITION": 16, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "modifiedDate", "ORDINAL_POSITION": 17, "COLUMN_DEFAULT": "(getutcdate())", "IS_NULLABLE": "NO", "DATA_TYPE": "datetime", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": 0, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "deleted", "ORDINAL_POSITION": 18, "COLUMN_DEFAULT": "((0))", "IS_NULLABLE": "NO", "DATA_TYPE": "bit", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "ORDINAL_POSITION": 1, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "uniqueidentifier", "CHARACTER_MAXIMUM_LENGTH": null, "CHARACTER_OCTET_LENGTH": null, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": null, "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": null, "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "name", "ORDINAL_POSITION": 2, "COLUMN_DEFAULT": null, "IS_NULLABLE": "NO", "DATA_TYPE": "nvarchar", "CHARACTER_MAXIMUM_LENGTH": 255, "CHARACTER_OCTET_LENGTH": 510, "NUMERIC_PRECISION": null, "NUMERIC_PRECISION_RADIX": null, "NUMERIC_SCALE": null, "DATETIME_PRECISION": null, "CHARACTER_SET_CATALOG": null, "CHARACTER_SET_SCHEMA": null, "CHARACTER_SET_NAME": "UNICODE", "COLLATION_CATALOG": null, "COLLATION_SCHEMA": null, "COLLATION_NAME": "SQL_Latin1_General_CP1_CI_AS", "DOMAIN_CATALOG": null, "DOMAIN_SCHEMA": null, "DOMAIN_NAME": null, "IS_IDENTITY": false }], "effectedRows": 20 }, { "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "UNIQUE", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>=(0))" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "CONSTRAINT_TYPE": "CHECK", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": "([decimal]>[integer])" }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "PRIMARY KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }, { "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "CONSTRAINT_TYPE": "FOREIGN KEY", "IS_DEFERRABLE": "NO", "INITIALLY_DEFERRED": "NO", "CHECK_CLAUSE": null }], "effectedRows": 7 }, { "rows": [{ "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema", "UNIQUE_CONSTRAINT_CATALOG": "Database", "UNIQUE_CONSTRAINT_SCHEMA": "dbo", "UNIQUE_CONSTRAINT_NAME": "UQ_Schema_identifier", "MATCH_OPTION": "SIMPLE", "UPDATE_RULE": "NO ACTION", "DELETE_RULE": "NO ACTION" }], "effectedRows": 1 }, { "effectedRows": 0 }, { "rows": [{ "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "own_Schema_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "primaryKey", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_Schema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "SubSchema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "PK_SubSchema" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "real", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_unique" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "identifier", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "UQ_Schema_identifier" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "CK_Schema_decimal" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "decimal", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }, { "TABLE_CATALOG": "Database", "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "COLUMN_NAME": "integer", "CONSTRAINT_CATALOG": "Database", "CONSTRAINT_SCHEMA": "dbo", "CONSTRAINT_NAME": "Schema_entity_check" }], "effectedRows": 9 }, { "rows": [{ "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pid" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "pclass" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "thumbprint" }, { "TABLE_SCHEMA": "dbo", "TABLE_NAME": "Schema", "INDEX_NAME": "IX_deleted", "IS_UNIQUE": false, type: "NONCLUSTERED", "COLUMN_NAME": "deleted" }], "effectedRows": 4 }];

            const schemaQuery = await db.getUpdateSchemaQueries([Schema, SubSchema]);

            chai.should();
            schemaQuery.should.deep.equal({
                "commit": [
                    { query: "ALTER TABLE [dbo].[SubSchema] DROP CONSTRAINT [own_Schema_SubSchema]", type: 4 }
                ],
                "rollback": [
                    { query: "ALTER TABLE [dbo].[SubSchema] ADD CONSTRAINT [own_Schema_SubSchema] FOREIGN KEY ([identifier]) REFERENCES [dbo].[Schema] ([identifier])", type: 4 }
                ]
            });

            entityMetaData.relations.push(relationMeta);
        });
        // it("should add relation data table", () => {
        //     class SubSchemaData {
        //         @IdentifierColumn()
        //         public id: UUID;
        //     }

        //     const relationDataFactory = RelationshipData<SubSchemaData>(Schema, "own", SubSchema, ["id"], ["id"]);
        //     relationDataFactory(SubSchemaData);

        // });
        // it("should add many-many relation", () => {
        // });
    });
});